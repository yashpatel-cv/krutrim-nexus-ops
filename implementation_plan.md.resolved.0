# Server Hardening & Orchestration Implementation Plan

## Goal Description
Design and deliver a cohesive, privacy-centric, defensive Linux platform for Debian 13 (ARM64) and Arch Linux (AMD64). The solution focuses on non-destructive in-place hardening, privacy networks (Tor/I2P), secure data handling (LUKS overlays), and a split-tier service architecture (Bash for base, Python for apps).

## Architecture Rationale

### 1. Pillars of the Architecture
*   **Non-Destructive Hardening**: We cannot repartition the root drive. We use **overlays**:
    *   **Swap**: `dm-crypt` with a random key on a file.
    *   **Data**: LUKS-encrypted loopback files for sensitive data (`/home/debian/secure`).
    *   **Snapshots**: Loop-mounted BTRFS volume for config versioning, avoiding root FS conversion.
*   **Split-Tier Management**:
    *   **Tier 1 (Base)**: `install.sh` (Bash). Handles "Life Support" (Network, SSH, Firewall, DNS, Package Mgmt). Must be robust, dependency-free (other than core utils), and run first.
    *   **Tier 2 (Apps)**: `services.py` (Python). Handles "Business Logic" (APIs, RSS, Static Sites). Leverages Python's superior string handling, JSON/YAML parsing, and process control for complex app orchestration.
*   **Privacy & Network**:
    *   **DNS**: Unbound as a local recursive resolver to prevent leaks and bypass upstream logging.
    *   **Anonymity**: Tor and I2P installed as system services, integrated via SOCKS/HTTP proxies.
    *   **Firewall**: `nftables` with a default-deny policy, explicitly allowing only verified traffic.

### 2. Key Design Decisions
*   **Caddy vs Nginx**: Caddy is chosen as default for Tier 1 Web due to automatic memory-safe HTTPS and simpler config, reducing maintenance burden.
*   **Python POSIX Module**: Instead of relying solely on `systemd` for sub-process management of dynamic apps, we implement `proc_ipc.py` to demonstrate robust POSIX handling (fork, exec, signals) for the Python orchestrator, allowing it to act as a supervisor for specific tasks if needed, though `systemd` remains the primary init system.
*   **Loopback Volumes**: Using files as block devices allows us to have encrypted partitions and BTRFS snapshots without touching the partition table of the VPS.

## Proposed Changes

### Phase 1: Base System (Bash)
#### [NEW] [install.sh](file:///C:/Users/yashp/.gemini/antigravity/brain/0f403ae0-901e-45c0-8bbe-995bd4ca1d3e/install.sh)
*   **Role**: Top-level installer.
*   **Logic**: Detects OS -> Sets up Repos -> Installs Base Pkgs -> Configures Network/Firewall -> Sets up Encrypted Overlays -> Hands off to Tier 2.
*   **Safety**: Checks for `krutrim-db-0` hostname to enforce non-destructive defaults.

#### [NEW] [nftables.conf](file:///C:/Users/yashp/.gemini/antigravity/brain/0f403ae0-901e-45c0-8bbe-995bd4ca1d3e/nftables.conf)
*   **Role**: Firewall configuration.
*   **Features**: Default deny, rate limiting, separate chains for services.

#### [NEW] [99-hardening.conf](file:///C:/Users/yashp/.gemini/antigravity/brain/0f403ae0-901e-45c0-8bbe-995bd4ca1d3e/99-hardening.conf)
*   **Role**: Kernel sysctl hardening.
*   **Features**: Network stack hardening, restricted dmesg/ptrace/BPF.

#### [NEW] [unbound.conf](file:///C:/Users/yashp/.gemini/antigravity/brain/0f403ae0-901e-45c0-8bbe-995bd4ca1d3e/unbound.conf)
*   **Role**: Local DNS resolver.

### Phase 2: Service Orchestration (Python)
#### [NEW] [proc_ipc.py](file:///C:/Users/yashp/.gemini/antigravity/brain/0f403ae0-901e-45c0-8bbe-995bd4ca1d3e/proc_ipc.py)
*   **Role**: Low-level POSIX process management library.
*   **Features**: `fork()`, `pipe()`, signal handling, non-blocking I/O.

#### [NEW] [services.py](file:///C:/Users/yashp/.gemini/antigravity/brain/0f403ae0-901e-45c0-8bbe-995bd4ca1d3e/services.py)
*   **Role**: Tier 2 service orchestrator.
*   **Features**: Reads `services.yml`, manages app lifecycles, backups (Restic).

#### [NEW] [run-services.sh](file:///C:/Users/yashp/.gemini/antigravity/brain/0f403ae0-901e-45c0-8bbe-995bd4ca1d3e/run-services.sh)
*   **Role**: Wrapper to bootstrap the Python environment and run `services.py`.

### Phase 3: Configs & Units
#### [NEW] [Caddyfile](file:///C:/Users/yashp/.gemini/antigravity/brain/0f403ae0-901e-45c0-8bbe-995bd4ca1d3e/Caddyfile)
*   **Role**: Web server config.

#### [NEW] [Systemd Units](file:///C:/Users/yashp/.gemini/antigravity/brain/0f403ae0-901e-45c0-8bbe-995bd4ca1d3e/)
*   `crypt-swap.service`, `secure-storage.service`, `snapshot-btrfs.service`.

## Verification Plan

### Automated Tests
*   **`verify.sh`**: A script to run post-install.
    *   Check `nftables` ruleset active.
    *   Check `unbound` resolving correctly (DNS leak test).
    *   Check `Tor`/`I2P` socks ports listening.
    *   Check Encrypted Swap status (`dmsetup status`).
    *   Check Mount points for secure overlays.
    *   Check HTTP status of Caddy.

### Manual Verification
*   **Reboot Test**: Ensure all services and encrypted mounts survive a reboot.
*   **Rollback Test**: Run `install.sh --rollback` (if implemented) or manually revert using `ROLLBACK.md` steps.
